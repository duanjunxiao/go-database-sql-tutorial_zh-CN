(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{199:function(t,a,s){"use strict";s.r(a);var n=s(0),e=Object(n.a)({},function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("在Go中使用预编译语句有这些好处:安全,高效和便捷.但它们的实现方式可能和你的习惯有点不同,特别是它们需要和"),s("code",[t._v("database/sql")]),t._v("的一些内部功能协调工作.")]),t._v(" "),s("h1",{attrs:{id:"预编译的语句和连接"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#预编译的语句和连接","aria-hidden":"true"}},[t._v("#")]),t._v(" 预编译的语句和连接")]),t._v(" "),s("p",[t._v("在数据库层面,一条预编译语句会绑定一个单独的连接.典型的流程是,客户端发送一条带占位符的SQL语句给数据库进行预编译,服务器再返回该语句的ID,然后客户端通过发送ID和参数来执行语句.")]),t._v(" "),s("p",[t._v("然而在Go中,连接不是直接暴露给"),s("code",[t._v("database/sql")]),t._v("包的使用者.你不能在一个连接上预编译语句.你需要在"),s("code",[t._v("DB")]),t._v("或"),s("code",[t._v("Tx")]),t._v("中使用.而且"),s("code",[t._v("database/sql")]),t._v("有一些方便的功能比如自动重试.由于这些原因,在驱动层面需要关联预编译语句和连接,其隐藏在你的代码中.")]),t._v(" "),s("p",[t._v("它是这样工作的:")]),t._v(" "),s("ol",[s("li",[t._v("当你要预编译一个语句时,需从连接池中获取一个连接.")]),t._v(" "),s("li",[s("code",[t._v("Stmt")]),t._v("对象记住使用了哪个连接.")]),t._v(" "),s("li",[t._v("当你执行"),s("code",[t._v("Stmt")]),t._v("时,它会尝试启用这个连接.如果它不可用,比如已是关闭或正在使用时,它会从连接池中重新获取另外一个连接,"),s("strong",[t._v("然后在新连接上重新预编译语句")])])]),t._v(" "),s("p",[t._v("因为语句在原始连接被占用时可以被重新预编译,在高并发的数据库中,这可能使得很多连接被使用或者创建了大量的预编译语句.这会导致明显的语句泄露,正在预编译的语句和要重新预编译的语句会比你想象的更多,甚至达到数据库对语句数量限制的上限.")]),t._v(" "),s("h1",{attrs:{id:"避免预处理语句"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#避免预处理语句","aria-hidden":"true"}},[t._v("#")]),t._v(" 避免预处理语句")]),t._v(" "),s("p",[t._v("Go会在幕后为你创建预编译语句.比如"),s("code",[t._v("db.Query(sql, param1, param2)")]),t._v(",其作用是预编译一个sql,传入参数执行它,最后关闭语句.")]),t._v(" "),s("p",[t._v("有时候,预编译语句不是你想要的.有如下几种情况:")]),t._v(" "),s("ol",[s("li",[t._v('数据库不支持预编译语句.例如当使用MySQL驱动时,你可以连接到MemSQL和Sphinx上,因为它们支持MySQL的wire协议.但是它们不支持"binary"协议,其中就包含预编译语句,它们会因出现混乱而失败.')]),t._v(" "),s("li",[t._v("语句不能被重用使得使用它们有些不值,而且也需要用其他方式处理安全问题,所以这些性能开销是不需要的.在"),s("a",{attrs:{href:"https://vividcortex.com/blog/2014/11/19/analyzing-prepared-statement-performance-with-vividcortex/",target:"_blank",rel:"noopener noreferrer"}},[t._v("VividCortex的博客"),s("OutboundLink")],1),t._v("上就有这样的例子.")])]),t._v(" "),s("p",[t._v("如果你不想使用预编译语句,那么你需要使用"),s("code",[t._v("fmt.Sprint()")]),t._v("或类试的方式来拼接SQL,将其作为唯一的参数传入"),s("code",[t._v("db.Query()")]),t._v("或"),s("code",[t._v("db.QueryRow()")]),t._v(".还有你的驱动需要支持纯文本的查询方式,其是通过Go1.1中添加的"),s("code",[t._v("Execer")]),t._v("和"),s("code",[t._v("Queryer")]),t._v("接口来支持的,"),s("a",{attrs:{href:"http://golang.org/pkg/database/sql/driver/#Execer",target:"_blank",rel:"noopener noreferrer"}},[t._v("文档在这里"),s("OutboundLink")],1),t._v(".")]),t._v(" "),s("h1",{attrs:{id:"在事务中使用预编译语句"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在事务中使用预编译语句","aria-hidden":"true"}},[t._v("#")]),t._v(" 在事务中使用预编译语句")]),t._v(" "),s("p",[s("code",[t._v("Tx")]),t._v("会创建和绑定预编译语句,所以上文关于预编译的警告并不适用于这里.当你使用"),s("code",[t._v("Tx")]),t._v("对象时,你的操作会被映射到底层的有且仅有的一个连接上.")]),t._v(" "),s("p",[t._v("这也意味着预编译语句是在"),s("code",[t._v("Tx")]),t._v("内创建的,不可单独使用.同样,在"),s("code",[t._v("DB")]),t._v("上创建的预编译语句也不能在事务中使用,因为它们会和不同的连接绑定.")]),t._v(" "),s("p",[t._v("若要在"),s("code",[t._v("Tx")]),t._v("中使用事务外定义的预编译语句,那么你可以使用"),s("code",[t._v("Tx.Stmt()")]),t._v(",它会通过事务外的预编译语句新建一个事务特有的语句.即它通过利用现有的预编译语句,设置连接到该事务,然后每次执行时预编译一次所有的语句.即使"),s("code",[t._v("database/sql")]),t._v("源码中的TODO清单指明会改进它,但这些操作和实现还是不受欢迎的;我们建议不要这样用.")]),t._v(" "),s("p",[t._v("在事务中使用预编译语句时必须谨慎.考虑下例:")]),t._v(" "),s("div",{staticClass:"language-go extra-class"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("tx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Begin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tlog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Fatal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("defer")]),t._v(" tx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Rollback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nstmt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" tx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Prepare")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INSERT INTO foo VALUES (?)"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tlog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Fatal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("defer")]),t._v(" stmt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Close")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// danger!")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" stmt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Exec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tlog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Fatal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nerr "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Commit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tlog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Fatal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// stmt.Close() runs here!")]),t._v("\n")])])]),s("p",[t._v("在Go1.4之前,关闭"),s("code",[t._v("*sql.Tx")]),t._v("时会将关联的连接释放回连接池,但关闭预编译语句会延迟到这(tx.Close)"),s("strong",[t._v("之后")]),t._v("进行,这可能会导致并发地访问底层连接,使得连接的状态出现不一致.如果你使用Go1.4或之后的版本,你应该确保在事务提交或回滚前关闭statement."),s("a",{attrs:{href:"https://github.com/golang/go/issues/4459",target:"_blank",rel:"noopener noreferrer"}},[t._v("该issue"),s("OutboundLink")],1),t._v("已在Go1.4的"),s("a",{attrs:{href:"https://codereview.appspot.com/131650043",target:"_blank",rel:"noopener noreferrer"}},[t._v("CR131650043"),s("OutboundLink")],1),t._v("中被修复.")]),t._v(" "),s("h1",{attrs:{id:"参数占位符的语法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数占位符的语法","aria-hidden":"true"}},[t._v("#")]),t._v(" 参数占位符的语法")]),t._v(" "),s("p",[t._v("预编译的参数占位符时数据库特有的,例如,比如MySQL,PostgreSQL和Oracle的:")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("MySQL")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("PostgreSQL")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("Oracle")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("WHERE col = ?")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("WHERE col = $1")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("WHERE col = :col")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("VALUES(?, ?, ?)")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("VALUES($1, $2, $3)")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("VALUES(:val1, :val2, :val3)")])])])])])},[],!1,null,null,null);a.default=e.exports}}]);
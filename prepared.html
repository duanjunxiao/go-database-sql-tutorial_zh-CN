<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用预编译语句 | Go database/sql 指南</title>
    <meta name="description" content="Go database/sql 指南">
    
    
    <link rel="preload" href="/go-database-sql-tutorial_zh-CN/assets/css/0.styles.f5a27033.css" as="style"><link rel="preload" href="/go-database-sql-tutorial_zh-CN/assets/js/app.5af14b52.js" as="script"><link rel="preload" href="/go-database-sql-tutorial_zh-CN/assets/js/2.78b45e4e.js" as="script"><link rel="preload" href="/go-database-sql-tutorial_zh-CN/assets/js/13.17822d68.js" as="script"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/10.abbaabed.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/11.eb0282f9.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/12.b9f22719.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/14.b34827d4.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/15.1358fa62.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/16.182683bb.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/17.a9612d2f.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/18.49b6b4f5.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/19.514e38f9.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/3.448d3f07.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/4.db65d4df.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/5.b0e3c3ab.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/6.5f8a94b7.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/7.17c6d805.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/8.5c4bcad8.js"><link rel="prefetch" href="/go-database-sql-tutorial_zh-CN/assets/js/9.0ffcea90.js">
    <link rel="stylesheet" href="/go-database-sql-tutorial_zh-CN/assets/css/0.styles.f5a27033.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/go-database-sql-tutorial_zh-CN/" class="home-link router-link-active"><!----> <span class="site-name">Go database/sql 指南</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://golang.google.cn/pkg/database/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  go database/sql
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/meilihao/go-database-sql-tutorial_zh-CN" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://golang.google.cn/pkg/database/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  go database/sql
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/meilihao/go-database-sql-tutorial_zh-CN" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/go-database-sql-tutorial_zh-CN/" class="sidebar-link">Home</a></li><li><a href="/go-database-sql-tutorial_zh-CN/tutorial.html" class="sidebar-link">介绍</a></li><li><a href="/go-database-sql-tutorial_zh-CN/overview.html" class="sidebar-link">概述</a></li><li><a href="/go-database-sql-tutorial_zh-CN/importing.html" class="sidebar-link">导入数据库驱动</a></li><li><a href="/go-database-sql-tutorial_zh-CN/accessing.html" class="sidebar-link">访问数据库</a></li><li><a href="/go-database-sql-tutorial_zh-CN/retrieving.html" class="sidebar-link">获取结果集</a></li><li><a href="/go-database-sql-tutorial_zh-CN/modifying.html" class="sidebar-link">修改数据和使用事务</a></li><li><a href="/go-database-sql-tutorial_zh-CN/prepared.html" class="active sidebar-link">使用预编译语句</a></li><li><a href="/go-database-sql-tutorial_zh-CN/errors.html" class="sidebar-link">错误处理</a></li><li><a href="/go-database-sql-tutorial_zh-CN/nulls.html" class="sidebar-link">使用Null</a></li><li><a href="/go-database-sql-tutorial_zh-CN/varcols.html" class="sidebar-link">使用未知列</a></li><li><a href="/go-database-sql-tutorial_zh-CN/connection-pool.html" class="sidebar-link">连接池</a></li><li><a href="/go-database-sql-tutorial_zh-CN/surprises.html" class="sidebar-link">意外,反模式,限制</a></li><li><a href="/go-database-sql-tutorial_zh-CN/references.html" class="sidebar-link">相关阅读和资源</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>在Go中使用预编译语句有这些好处:安全,高效和便捷.但它们的实现方式可能和你的习惯有点不同,特别是它们需要和<code>database/sql</code>的一些内部功能协调工作.</p> <h1 id="预编译的语句和连接"><a href="#预编译的语句和连接" aria-hidden="true" class="header-anchor">#</a> 预编译的语句和连接</h1> <p>在数据库层面,一条预编译语句会绑定一个单独的连接.典型的流程是,客户端发送一条带占位符的SQL语句给数据库进行预编译,服务器再返回该语句的ID,然后客户端通过发送ID和参数来执行语句.</p> <p>然而在Go中,连接不是直接暴露给<code>database/sql</code>包的使用者.你不能在一个连接上预编译语句.你需要在<code>DB</code>或<code>Tx</code>中使用.而且<code>database/sql</code>有一些方便的功能比如自动重试.由于这些原因,在驱动层面需要关联预编译语句和连接,其隐藏在你的代码中.</p> <p>它是这样工作的:</p> <ol><li>当你要预编译一个语句时,需从连接池中获取一个连接.</li> <li><code>Stmt</code>对象记住使用了哪个连接.</li> <li>当你执行<code>Stmt</code>时,它会尝试启用这个连接.如果它不可用,比如已是关闭或正在使用时,它会从连接池中重新获取另外一个连接,<strong>然后在新连接上重新预编译语句</strong></li></ol> <p>因为语句在原始连接被占用时可以被重新预编译,在高并发的数据库中,这可能使得很多连接被使用或者创建了大量的预编译语句.这会导致明显的语句泄露,正在预编译的语句和要重新预编译的语句会比你想象的更多,甚至达到数据库对语句数量限制的上限.</p> <h1 id="避免预处理语句"><a href="#避免预处理语句" aria-hidden="true" class="header-anchor">#</a> 避免预处理语句</h1> <p>Go会在幕后为你创建预编译语句.比如<code>db.Query(sql, param1, param2)</code>,其作用是预编译一个sql,传入参数执行它,最后关闭语句.</p> <p>有时候,预编译语句不是你想要的.有如下几种情况:</p> <ol><li>数据库不支持预编译语句.例如当使用MySQL驱动时,你可以连接到MemSQL和Sphinx上,因为它们支持MySQL的wire协议.但是它们不支持&quot;binary&quot;协议,其中就包含预编译语句,它们会因出现混乱而失败.</li> <li>语句不能被重用使得使用它们有些不值,而且也需要用其他方式处理安全问题,所以这些性能开销是不需要的.在<a href="https://vividcortex.com/blog/2014/11/19/analyzing-prepared-statement-performance-with-vividcortex/" target="_blank" rel="noopener noreferrer">VividCortex的博客<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>上就有这样的例子.</li></ol> <p>如果你不想使用预编译语句,那么你需要使用<code>fmt.Sprint()</code>或类试的方式来拼接SQL,将其作为唯一的参数传入<code>db.Query()</code>或<code>db.QueryRow()</code>.还有你的驱动需要支持纯文本的查询方式,其是通过Go1.1中添加的<code>Execer</code>和<code>Queryer</code>接口来支持的,<a href="http://golang.org/pkg/database/sql/driver/#Execer" target="_blank" rel="noopener noreferrer">文档在这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h1 id="在事务中使用预编译语句"><a href="#在事务中使用预编译语句" aria-hidden="true" class="header-anchor">#</a> 在事务中使用预编译语句</h1> <p><code>Tx</code>会创建和绑定预编译语句,所以上文关于预编译的警告并不适用于这里.当你使用<code>Tx</code>对象时,你的操作会被映射到底层的有且仅有的一个连接上.</p> <p>这也意味着预编译语句是在<code>Tx</code>内创建的,不可单独使用.同样,在<code>DB</code>上创建的预编译语句也不能在事务中使用,因为它们会和不同的连接绑定.</p> <p>若要在<code>Tx</code>中使用事务外定义的预编译语句,那么你可以使用<code>Tx.Stmt()</code>,它会通过事务外的预编译语句新建一个事务特有的语句.即它通过利用现有的预编译语句,设置连接到该事务,然后每次执行时预编译一次所有的语句.即使<code>database/sql</code>源码中的TODO清单指明会改进它,但这些操作和实现还是不受欢迎的;我们建议不要这样用.</p> <p>在事务中使用预编译语句时必须谨慎.考虑下例:</p> <div class="language-go extra-class"><pre class="language-go"><code>tx<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">defer</span> tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
stmt<span class="token punctuation">,</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Prepare</span><span class="token punctuation">(</span><span class="token string">&quot;INSERT INTO foo VALUES (?)&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">defer</span> stmt<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// danger!</span>
<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> stmt<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// stmt.Close() runs here!</span>
</code></pre></div><p>在Go1.4之前,关闭<code>*sql.Tx</code>时会将关联的连接释放回连接池,但关闭预编译语句会延迟到这(tx.Close)<strong>之后</strong>进行,这可能会导致并发地访问底层连接,使得连接的状态出现不一致.如果你使用Go1.4或之后的版本,你应该确保在事务提交或回滚前关闭statement.<a href="https://github.com/golang/go/issues/4459" target="_blank" rel="noopener noreferrer">该issue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>已在Go1.4的<a href="https://codereview.appspot.com/131650043" target="_blank" rel="noopener noreferrer">CR131650043<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中被修复.</p> <h1 id="参数占位符的语法"><a href="#参数占位符的语法" aria-hidden="true" class="header-anchor">#</a> 参数占位符的语法</h1> <p>预编译的参数占位符时数据库特有的,例如,比如MySQL,PostgreSQL和Oracle的:</p> <table><thead><tr><th style="text-align:center;">MySQL</th> <th style="text-align:center;">PostgreSQL</th> <th style="text-align:center;">Oracle</th></tr></thead> <tbody><tr><td style="text-align:center;">WHERE col = ?</td> <td style="text-align:center;">WHERE col = $1</td> <td style="text-align:center;">WHERE col = :col</td></tr> <tr><td style="text-align:center;">VALUES(?, ?, ?)</td> <td style="text-align:center;">VALUES($1, $2, $3)</td> <td style="text-align:center;">VALUES(:val1, :val2, :val3)</td></tr></tbody></table></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/meilihao/go-database-sql-tutorial_zh-CN/edit/master/docs/prepared.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">7/4/2019, 4:46:08 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/go-database-sql-tutorial_zh-CN/modifying.html" class="prev">
          修改数据和使用事务
        </a></span> <span class="next"><a href="/go-database-sql-tutorial_zh-CN/errors.html">
          错误处理
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/go-database-sql-tutorial_zh-CN/assets/js/app.5af14b52.js" defer></script><script src="/go-database-sql-tutorial_zh-CN/assets/js/2.78b45e4e.js" defer></script><script src="/go-database-sql-tutorial_zh-CN/assets/js/13.17822d68.js" defer></script>
  </body>
</html>
